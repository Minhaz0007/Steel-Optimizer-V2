steps:
  # ── 1. Build the Docker image ──────────────────────────────────────────
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - build
      - -t
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:$COMMIT_SHA'
      - -t
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:latest'
      - .

  # ── 2. Push the image to Artifact Registry ─────────────────────────────
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - push
      - --all-tags
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}'

  # ── 3. Deploy to Cloud Run ─────────────────────────────────────────────
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - run
      - deploy
      - '${_SERVICE_NAME}'
      - --image
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_SERVICE_NAME}/${_SERVICE_NAME}:$COMMIT_SHA'
      - --region
      - '${_REGION}'
      - --platform
      - managed
      - --allow-unauthenticated
      - --port
      - '8080'
      - --memory
      - '512Mi'
      - --min-instances
      - '0'
      - --max-instances
      - '3'

substitutions:
  _SERVICE_NAME: steel-optimizer   # Cloud Run service name (change if needed)
  _REGION: us-central1             # GCP region (change if needed)

options:
  logging: CLOUD_LOGGING_ONLY
